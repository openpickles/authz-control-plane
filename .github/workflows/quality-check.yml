name: Quality Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # Backend Setup & Test
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'

    - name: Backend Unit Tests
      working-directory: ./backend
      run: mvn test

    # Frontend Setup & Test
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: './frontend/package-lock.json'

    - name: Install Frontend Dependencies
      working-directory: ./frontend
      run: npm ci

    - name: Frontend Unit Tests
      working-directory: ./frontend
      run: npm test

    # E2E Tests
    - name: Install Playwright Browsers
      working-directory: ./frontend
      run: npx playwright install --with-deps

    - name: Start Backend
      working-directory: ./backend
      # Run in background, wait for start
      run: |
        mvn spring-boot:run &
        # Simple wait loop for port 8080
        echo "Waiting for backend..."
        timeout 120 bash -c 'until curl -s http://localhost:8080/actuator/health; do sleep 5; done'

    - name: Run Playwright Tests
      working-directory: ./frontend
      run: npx playwright test
